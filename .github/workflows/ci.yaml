name: CI

on:
  push:
    branches: [ master, 'feature/*', 'fix/*' ] # 只要 push commit 到指定 branch (如 master, feature/*, fix/*)，就會觸發 CI
  pull_request:
    branches: [ master ] # 當 feature branch 合併到 master，也會觸發 CI

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: myimage:latest
          cache-from: type=gha 
          cache-to: type=gha

      - name: Build Test Docker Image
        run: docker build -t airflow-test -f test/Dockerfile.test .

      - name: Run tests in Test Docker Container
        run: |
          docker run --name airflow-test-container --rm \
            airflow-test \
            pytest --log-level=INFO test/ -xvv --cov=plugins --cov=dags 

      - name: Comment BUILD SUCCESS on PR
        if: github.event_name == 'pull_request' && success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            🎉 **BUILD SUCCESS**
            All tests passed, CI build successful!