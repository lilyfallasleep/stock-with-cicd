name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  ci:
    if: |
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: myimage:latest
          cache-from: type=gha 
          cache-to: type=gha

      - name: Build Test Docker Image
        run: docker build -t airflow-test -f test/Dockerfile.test .

      - name: Run tests in Test Docker Container
        run: |
          docker run --name airflow-test-container --rm \
            airflow-test \
            pytest --log-level=INFO test/ -xvv --cov=plugins --cov=dags 

      - name: Comment BUILD SUCCESS on PR
        if: github.event_name == 'pull_request' && success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üéâ **BUILD SUCCESS**
            All tests passed, CI build successful!

      - name: Comment BUILD FAILURE on PR
        if: github.event_name == 'pull_request' && failure()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ùå **BUILD FAILURE**
            Some tests failed, CI build unsuccessful. Please check the logs for details.